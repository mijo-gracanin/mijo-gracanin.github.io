<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta property="og:site_name" content="MijoCoder"/><link rel="canonical" href="https://mijo-gracanin.github.io/posts/urlcache-inspection"/><meta name="twitter:url" content="https://mijo-gracanin.github.io/posts/urlcache-inspection"/><meta property="og:url" content="https://mijo-gracanin.github.io/posts/urlcache-inspection"/><title>URLCache inspection | MijoCoder</title><meta name="twitter:title" content="URLCache inspection | MijoCoder"/><meta property="og:title" content="URLCache inspection | MijoCoder"/><meta name="description" content="TIL something new about URLCache, URLSession and session delegate"/><meta name="twitter:description" content="TIL something new about URLCache, URLSession and session delegate"/><meta property="og:description" content="TIL something new about URLCache, URLSession and session delegate"/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to MijoCoder"/></head><body class="item-page"><header><div class="wrapper"><a href="/" class="site-name">MijoCoder</a><nav><ul><li><a href="/posts" class="selected">Posts</a></li><li><a href="/about">About</a></li></ul></nav></div></header><div class="wrapper"><article><div class="content"><h1>URLCache inspection</h1><p>Some responses should be cached to reduce network traffic, speed up an app, or support offline mode. Other responses, especially the ones that contain sensitive info, should not be cached. So it makes sense to verify what's in the URLCache. If possible, before you get a pen-test report from a third-party ;)</p><p>We can use the URLCache's <code>cachedResponse(for:)</code> API to check what is cached. But when I passed to the API the same URLRequest I passed to the <code>dataTask(with:)</code> API, I got back a <code>nil</code>.</p><p>With URLCache <code>currentMemoryUsage</code> API I confirmed that the memory usage increased, so it was time to implement <code>URLSessionDataDelegate</code> and its <code>urlSession(_:dataTask:willCacheResponse:completionHandler:)</code> method to find out what's happening. But my delegate method was not called. It turned out it wouldn't get called if the content was retrieved with <code>dataTask(with:completionHandler:)</code> or <code>dataTaskPublisher(for:)</code>. I had to use the <code>dataTask(with:)</code> API.</p><p>The delegate method revealed that the two properties of the dataTask, <code>originalRequest</code> and <code>currentRequest</code>, were not the same in my case. The <code>originalRequest</code> was the same request I used when calling the <code>dataTask(with:)</code> API, and the <code>currentRequest</code> had additional headers and was used as a key for URLCache. Those additional headers came from</p><p><code>httpAdditionalHeaders</code> property of <code>URLSessionConfiguration</code>.</p></div><span>Tagged with: </span><ul class="tag-list"><li><a href="/tags/urlcache">urlcache</a></li><li><a href="/tags/urlsession">urlsession</a></li><li><a href="/tags/urlrequest">urlrequest</a></li><li><a href="/tags/urlresponse">urlresponse</a></li></ul></article></div><footer><p>Generated using <a href="https://github.com/johnsundell/publish">Publish</a></p><p><a href="/feed.rss">RSS feed</a></p></footer></body></html>